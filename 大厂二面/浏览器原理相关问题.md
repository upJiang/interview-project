# æµè§ˆå™¨åŸç†ç›¸å…³é—®é¢˜ - å‰ç«¯é¢è¯•æŒ‡å—

## ğŸ“‹ å¸¸è§é¢è¯•é¢˜ä¸ç­”æ¡ˆ

### Q1: æµè§ˆå™¨æ¸²æŸ“æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
æµè§ˆå™¨æ¸²æŸ“æµç¨‹åŒ…æ‹¬ï¼šè§£æHTML â†’ æ„å»ºDOMæ ‘ â†’ è§£æCSS â†’ æ„å»ºCSSOMæ ‘ â†’ åˆå¹¶DOMå’ŒCSSOM â†’ å¸ƒå±€ â†’ ç»˜åˆ¶ â†’ åˆæˆã€‚

**é¢è¯•å›ç­”æŠ€å·§ï¼š**
```javascript
// æµè§ˆå™¨æ¸²æŸ“æµç¨‹æ¨¡æ‹Ÿ
class BrowserRenderer {
  constructor() {
    this.domTree = null;
    this.cssomTree = null;
    this.renderTree = null;
  }

  // 1. è§£æHTMLæ„å»ºDOMæ ‘
  parseHTML(html) {
    console.log('1. Parsing HTML...');
    this.domTree = this.buildDOMTree(html);
    console.log('DOM Tree built:', this.domTree);
  }

  // 2. è§£æCSSæ„å»ºCSSOMæ ‘
  parseCSS(css) {
    console.log('2. Parsing CSS...');
    this.cssomTree = this.buildCSSOMTree(css);
    console.log('CSSOM Tree built:', this.cssomTree);
  }

  // 3. åˆå¹¶DOMå’ŒCSSOM
  mergeTrees() {
    console.log('3. Merging DOM and CSSOM...');
    this.renderTree = this.combineTrees(this.domTree, this.cssomTree);
    console.log('Render Tree built:', this.renderTree);
  }

  // 4. å¸ƒå±€è®¡ç®—
  layout() {
    console.log('4. Calculating layout...');
    this.calculateLayout(this.renderTree);
    console.log('Layout calculated');
  }

  // 5. ç»˜åˆ¶
  paint() {
    console.log('5. Painting...');
    this.drawElements(this.renderTree);
    console.log('Painting completed');
  }

  // 6. åˆæˆ
  composite() {
    console.log('6. Compositing...');
    this.compositeLayers();
    console.log('Compositing completed');
  }

  render(html, css) {
    this.parseHTML(html);
    this.parseCSS(css);
    this.mergeTrees();
    this.layout();
    this.paint();
    this.composite();
  }
}
```

### Q2: ä»€ä¹ˆæ˜¯é‡æ’(Reflow)å’Œé‡ç»˜(Repaint)ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
é‡æ’æ˜¯é‡æ–°è®¡ç®—å…ƒç´ å‡ ä½•å±æ€§ï¼Œé‡ç»˜æ˜¯é‡æ–°ç»˜åˆ¶å…ƒç´ å¤–è§‚ã€‚

**é¢è¯•å›ç­”æŠ€å·§ï¼š**
```javascript
// é‡æ’é‡ç»˜ä¼˜åŒ–ç¤ºä¾‹
class ReflowRepaintOptimizer {
  constructor() {
    this.batchUpdates = [];
    this.isBatching = false;
  }

  // æ‰¹é‡æ›´æ–°é¿å…é‡æ’
  batchUpdate(callback) {
    this.isBatching = true;
    callback();
    this.isBatching = false;
    this.flushUpdates();
  }

  // ä½¿ç”¨transformä»£æ›¿top/left
  optimizeTransform(element, x, y) {
    // å¥½çš„åšæ³•ï¼šä½¿ç”¨transform
    element.style.transform = `translate(${x}px, ${y}px)`;
    
    // é¿å…çš„åšæ³•ï¼šç›´æ¥ä¿®æ”¹top/left
    // element.style.top = y + 'px';
    // element.style.left = x + 'px';
  }

  // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–åŠ¨ç”»
  smoothAnimation(element, targetX, targetY) {
    const animate = () => {
      const currentX = parseFloat(element.style.transform.match(/translateX\(([^)]+)\)/)?.[1] || 0);
      const currentY = parseFloat(element.style.transform.match(/translateY\(([^)]+)\)/)?.[1] || 0);
      
      const deltaX = (targetX - currentX) * 0.1;
      const deltaY = (targetY - currentY) * 0.1;
      
      if (Math.abs(deltaX) > 0.1 || Math.abs(deltaY) > 0.1) {
        element.style.transform = `translate(${currentX + deltaX}px, ${currentY + deltaY}px)`;
        requestAnimationFrame(animate);
      }
    };
    
    requestAnimationFrame(animate);
  }

  // åˆ†ç¦»è¯»å†™æ“ä½œ
  optimizeReadWrite(element) {
    // æ‰¹é‡è¯»å–
    const width = element.offsetWidth;
    const height = element.offsetHeight;
    const style = window.getComputedStyle(element);
    
    // æ‰¹é‡å†™å…¥
    element.style.width = width * 2 + 'px';
    element.style.height = height * 2 + 'px';
    element.style.backgroundColor = 'red';
  }
}
```

### Q3: äº‹ä»¶å¾ªç¯(Event Loop)çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
äº‹ä»¶å¾ªç¯æ˜¯JavaScriptå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„æœºåˆ¶ï¼ŒåŒ…æ‹¬è°ƒç”¨æ ˆã€ä»»åŠ¡é˜Ÿåˆ—ã€å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

**é¢è¯•å›ç­”æŠ€å·§ï¼š**
```javascript
// äº‹ä»¶å¾ªç¯æ¨¡æ‹Ÿ
class EventLoop {
  constructor() {
    this.callStack = [];
    this.macroTaskQueue = [];
    this.microTaskQueue = [];
    this.isRunning = false;
  }

  // æ‰§è¡ŒåŒæ­¥ä»£ç 
  executeSync(code) {
    console.log('Executing sync code:', code);
    this.callStack.push(code);
    // æ‰§è¡Œä»£ç ...
    this.callStack.pop();
  }

  // æ·»åŠ å®ä»»åŠ¡
  addMacroTask(task) {
    console.log('Adding macro task:', task);
    this.macroTaskQueue.push(task);
  }

  // æ·»åŠ å¾®ä»»åŠ¡
  addMicroTask(task) {
    console.log('Adding micro task:', task);
    this.microTaskQueue.push(task);
  }

  // æ‰§è¡Œå¾®ä»»åŠ¡
  executeMicroTasks() {
    while (this.microTaskQueue.length > 0) {
      const task = this.microTaskQueue.shift();
      console.log('Executing micro task:', task);
      task();
    }
  }

  // æ‰§è¡Œå®ä»»åŠ¡
  executeMacroTasks() {
    if (this.macroTaskQueue.length > 0) {
      const task = this.macroTaskQueue.shift();
      console.log('Executing macro task:', task);
      task();
    }
  }

  // äº‹ä»¶å¾ªç¯ä¸»æµç¨‹
  run() {
    this.isRunning = true;
    
    while (this.isRunning) {
      // 1. æ‰§è¡ŒåŒæ­¥ä»£ç 
      if (this.callStack.length > 0) {
        this.executeSync(this.callStack[this.callStack.length - 1]);
      }
      
      // 2. æ‰§è¡Œå¾®ä»»åŠ¡
      this.executeMicroTasks();
      
      // 3. æ‰§è¡Œå®ä»»åŠ¡
      this.executeMacroTasks();
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const eventLoop = new EventLoop();

// åŒæ­¥ä»£ç 
eventLoop.executeSync('console.log("1")');

// å®ä»»åŠ¡
eventLoop.addMacroTask(() => {
  console.log('2 - Macro task');
  eventLoop.addMicroTask(() => console.log('3 - Micro task'));
});

// å¾®ä»»åŠ¡
eventLoop.addMicroTask(() => console.log('4 - Micro task'));
```

### Q4: ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
å†…å­˜æ³„æ¼æ˜¯ç¨‹åºä¸å†ä½¿ç”¨çš„å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå¯¼è‡´å†…å­˜å ç”¨æŒç»­å¢é•¿ã€‚

**é¢è¯•å›ç­”æŠ€å·§ï¼š**
```javascript
// å†…å­˜æ³„æ¼æ£€æµ‹å’Œé¿å…
class MemoryLeakDetector {
  constructor() {
    this.weakRefs = new WeakMap();
    this.eventListeners = new Map();
  }

  // ä½¿ç”¨WeakMapé¿å…å†…å­˜æ³„æ¼
  createWeakReference(obj, key) {
    this.weakRefs.set(obj, key);
    return obj;
  }

  // æ­£ç¡®çš„äº‹ä»¶ç›‘å¬å™¨ç®¡ç†
  addEventListenerWithCleanup(element, event, handler) {
    element.addEventListener(event, handler);
    
    if (!this.eventListeners.has(element)) {
      this.eventListeners.set(element, new Map());
    }
    
    const elementListeners = this.eventListeners.get(element);
    if (!elementListeners.has(event)) {
      elementListeners.set(event, []);
    }
    
    elementListeners.get(event).push(handler);
  }

  // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
  removeEventListeners(element) {
    const elementListeners = this.eventListeners.get(element);
    if (elementListeners) {
      elementListeners.forEach((handlers, event) => {
        handlers.forEach(handler => {
          element.removeEventListener(event, handler);
        });
      });
      this.eventListeners.delete(element);
    }
  }

  // å®šæ—¶å™¨æ¸…ç†
  createCleanupTimer(callback, delay) {
    const timerId = setTimeout(callback, delay);
    
    return {
      clear: () => {
        clearTimeout(timerId);
      }
    };
  }

  // é—­åŒ…å†…å­˜æ³„æ¼æ£€æµ‹
  detectClosureLeak() {
    let leakedData = null;
    
    // å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼çš„é—­åŒ…
    const leakyClosure = () => {
      leakedData = new Array(1000000).fill('leak');
      console.log('Data created in closure');
    };
    
    // æ­£ç¡®çš„åšæ³•ï¼šåŠæ—¶æ¸…ç†
    const cleanClosure = () => {
      const tempData = new Array(1000000).fill('temp');
      console.log('Data created and will be garbage collected');
      // tempDataä¼šåœ¨å‡½æ•°ç»“æŸåè¢«åƒåœ¾å›æ”¶
    };
    
    return { leakyClosure, cleanClosure };
  }
}
```

### Q5: æµè§ˆå™¨ç¼“å­˜æœºåˆ¶æœ‰å“ªäº›ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
æµè§ˆå™¨ç¼“å­˜åŒ…æ‹¬HTTPç¼“å­˜ã€Service Workerç¼“å­˜ã€æµè§ˆå™¨å­˜å‚¨ç­‰ã€‚

**é¢è¯•å›ç­”æŠ€å·§ï¼š**
```javascript
// æµè§ˆå™¨ç¼“å­˜ç®¡ç†
class BrowserCacheManager {
  constructor() {
    this.serviceWorker = null;
  }

  // HTTPç¼“å­˜æ§åˆ¶
  setCacheHeaders(response, maxAge = 3600) {
    response.headers.set('Cache-Control', `max-age=${maxAge}`);
    response.headers.set('ETag', this.generateETag(response));
    return response;
  }

  // Service Workerç¼“å­˜
  async setupServiceWorker() {
    if ('serviceWorker' in navigator) {
      try {
        this.serviceWorker = await navigator.serviceWorker.register('/sw.js');
        console.log('Service Worker registered');
      } catch (error) {
        console.error('Service Worker registration failed:', error);
      }
    }
  }

  // æœ¬åœ°å­˜å‚¨ç¼“å­˜
  setLocalStorageCache(key, value, ttl = 3600000) {
    const item = {
      value,
      timestamp: Date.now(),
      ttl
    };
    localStorage.setItem(key, JSON.stringify(item));
  }

  getLocalStorageCache(key) {
    const item = localStorage.getItem(key);
    if (!item) return null;
    
    const data = JSON.parse(item);
    if (Date.now() - data.timestamp > data.ttl) {
      localStorage.removeItem(key);
      return null;
    }
    
    return data.value;
  }

  // IndexedDBç¼“å­˜
  async setupIndexedDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('CacheDB', 1);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('cache')) {
          db.createObjectStore('cache', { keyPath: 'key' });
        }
      };
    });
  }
}
```

### Q6: æµè§ˆå™¨å®‰å…¨æœºåˆ¶æœ‰å“ªäº›ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
æµè§ˆå™¨å®‰å…¨æœºåˆ¶åŒ…æ‹¬åŒæºç­–ç•¥ã€CSPã€XSSé˜²æŠ¤ã€CSRFé˜²æŠ¤ç­‰ã€‚

**é¢è¯•å›ç­”æŠ€å·§ï¼š**
```javascript
// æµè§ˆå™¨å®‰å…¨é˜²æŠ¤
class BrowserSecurity {
  constructor() {
    this.cspPolicy = "default-src 'self'; script-src 'self' 'unsafe-inline'";
  }

  // è®¾ç½®CSP
  setCSP() {
    const meta = document.createElement('meta');
    meta.httpEquiv = 'Content-Security-Policy';
    meta.content = this.cspPolicy;
    document.head.appendChild(meta);
  }

  // XSSé˜²æŠ¤
  sanitizeInput(input) {
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
  }

  // CSRF Tokenç”Ÿæˆ
  generateCSRFToken() {
    const token = Math.random().toString(36).substr(2);
    sessionStorage.setItem('csrfToken', token);
    return token;
  }

  // éªŒè¯CSRF Token
  validateCSRFToken(token) {
    const storedToken = sessionStorage.getItem('csrfToken');
    return token === storedToken;
  }

  // å®‰å…¨çš„AJAXè¯·æ±‚
  secureAjax(url, data) {
    const token = this.generateCSRFToken();
    
    return fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': token
      },
      body: JSON.stringify(data)
    });
  }
}
```

## ğŸ¯ é¢è¯•æŠ€å·§æ€»ç»“

### å›ç­”ç­–ç•¥

**1. æ¦‚å¿µç†è§£**
- ç†è§£æµè§ˆå™¨æ¸²æŸ“æµç¨‹å’ŒåŸç†
- è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦è¿™äº›æœºåˆ¶

**2. å®è·µç»éªŒ**
- å±•ç¤ºå®é™…çš„æ€§èƒ½ä¼˜åŒ–ä»£ç 
- è¯´æ˜å†…å­˜ç®¡ç†å’Œå®‰å…¨é˜²æŠ¤

**3. æŠ€æœ¯æ·±åº¦**
- ç†è§£äº‹ä»¶å¾ªç¯å’Œå¼‚æ­¥æœºåˆ¶
- æŒæ¡æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

### åŠ åˆ†ç‚¹

1. **æ€§èƒ½ä¼˜åŒ–æ„è¯†**ï¼šä¸»åŠ¨æåŠé‡æ’é‡ç»˜ä¼˜åŒ–
2. **å†…å­˜ç®¡ç†**ï¼šå±•ç¤ºå†…å­˜æ³„æ¼æ£€æµ‹å’Œé¿å…
3. **å®‰å…¨è€ƒè™‘**ï¼šè¯´æ˜æµè§ˆå™¨å®‰å…¨æœºåˆ¶
4. **å®é™…ç»éªŒ**ï¼šåˆ†äº«çœŸå®çš„æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹

### å¸¸è§è¯¯åŒº

1. **åªå…³æ³¨è¡¨é¢**ï¼šè¦ç†è§£åº•å±‚åŸç†
2. **å¿½è§†æ€§èƒ½**ï¼šè¦æ³¨æ„æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–
3. **ç¼ºä¹å®‰å…¨æ„è¯†**ï¼šè¦é‡è§†å®‰å…¨é˜²æŠ¤
4. **æ²¡æœ‰å®è·µç»éªŒ**ï¼šè¦æœ‰å®é™…çš„é—®é¢˜è§£å†³ç»éªŒ

### é¢è¯•å‡†å¤‡æ¸…å•

- [ ] ç†è§£æµè§ˆå™¨æ¸²æŸ“æµç¨‹
- [ ] æŒæ¡é‡æ’é‡ç»˜ä¼˜åŒ–æ–¹æ³•
- [ ] äº†è§£äº‹ä»¶å¾ªç¯æœºåˆ¶
- [ ] æŒæ¡å†…å­˜æ³„æ¼æ£€æµ‹å’Œé¿å…
- [ ] äº†è§£æµè§ˆå™¨ç¼“å­˜æœºåˆ¶
- [ ] å‡†å¤‡å®é™…é¡¹ç›®æ¡ˆä¾‹

## ğŸ’¡ æ€»ç»“

æµè§ˆå™¨åŸç†åœ¨å‰ç«¯å¼€å‘ä¸­ä¸»è¦ç”¨äºï¼š
1. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ¸²æŸ“æµç¨‹ä¼˜åŒ–ã€é‡æ’é‡ç»˜é¿å…
2. **å†…å­˜ç®¡ç†**ï¼šå†…å­˜æ³„æ¼æ£€æµ‹å’Œé¿å…
3. **å¼‚æ­¥å¤„ç†**ï¼šäº‹ä»¶å¾ªç¯ç†è§£å’Œä¼˜åŒ–
4. **å®‰å…¨é˜²æŠ¤**ï¼šæµè§ˆå™¨å®‰å…¨æœºåˆ¶åº”ç”¨

é¢è¯•æ—¶è¦é‡ç‚¹å±•ç¤ºï¼š
- å¯¹æµè§ˆå™¨æ¸²æŸ“åŸç†çš„ç†è§£
- å®é™…çš„æ€§èƒ½ä¼˜åŒ–ç»éªŒ
- å†…å­˜ç®¡ç†å’Œå®‰å…¨é˜²æŠ¤æ„è¯†
- é—®é¢˜æ’æŸ¥å’Œè§£å†³èƒ½åŠ› 