# 微信小程序生命周期

## 应用生命周期

App函数用于注册一个小程序，通过App构造器提供的生命周期回调，可以监听小程序的运行状态：

```javascript
App({
  // 小程序初始化完成时触发，全局只触发一次
  onLaunch: function(options) {
    console.log('小程序初始化完成')
    console.log('启动参数:', options)
    
    // options包含:
    // 1. path - 启动页面路径
    // 2. query - 启动参数
    // 3. scene - 场景值
    // 4. shareTicket - 分享信息
    // 5. referrerInfo - 来源信息
  },
  
  // 小程序启动，或从后台进入前台显示时触发
  onShow: function(options) {
    console.log('小程序显示')
    console.log('显示参数:', options)
    
    // 可在此处处理:
    // 1. 从后台恢复状态
    // 2. 刷新数据
    // 3. 记录用户活跃状态
  },
  
  // 小程序从前台进入后台时触发
  onHide: function() {
    console.log('小程序隐藏')
    
    // 可在此处处理:
    // 1. 暂停音乐播放
    // 2. 保存用户操作状态
    // 3. 暂停定时器或动画
  },
  
  // 小程序发生脚本错误或API调用错误时触发
  onError: function(error) {
    console.error('小程序发生错误:', error)
    
    // 可在此处:
    // 1. 记录错误日志
    // 2. 上报错误信息
  },
  
  // 小程序要打开的页面不存在时触发
  onPageNotFound: function(res) {
    console.log('页面不存在:', res.path)
    
    // 可在此处:
    // 1. 跳转到404页面
    wx.redirectTo({
      url: 'pages/404/404'
    })
  },
  
  // 全局数据
  globalData: {
    userInfo: null,
    token: ''
  }
})
```

## 页面生命周期

Page函数用于注册一个页面，通过Page构造器提供的生命周期回调，可以监听页面的加载和渲染过程：

```javascript
Page({
  data: {
    message: '页面数据'
  },
  
  // 页面加载时触发，一个页面只会调用一次
  onLoad: function(options) {
    console.log('页面加载')
    console.log('页面参数:', options)
    
    // 常见操作:
    // 1. 解析路由参数
    // 2. 初始化页面数据
    // 3. 发起网络请求
  },
  
  // 页面显示/切入前台时触发
  onShow: function() {
    console.log('页面显示')
    
    // 常见操作:
    // 1. 刷新页面数据
    // 2. 开始播放音频或视频
  },
  
  // 页面初次渲染完成时触发，一个页面只会调用一次
  onReady: function() {
    console.log('页面初次渲染完成')
    
    // 常见操作:
    // 1. 获取页面元素
    // 2. 执行需要等待页面渲染完成的操作
  },
  
  // 页面隐藏/切入后台时触发
  onHide: function() {
    console.log('页面隐藏')
    
    // 常见操作:
    // 1. 暂停播放音频或视频
    // 2. 暂停定时器
  },
  
  // 页面卸载时触发
  onUnload: function() {
    console.log('页面卸载')
    
    // 常见操作:
    // 1. 清理定时器
    // 2. 保存未提交的表单数据
  },
  
  // 下拉刷新时触发
  onPullDownRefresh: function() {
    console.log('触发下拉刷新')
    
    // 刷新完成后停止下拉刷新动画
    setTimeout(function() {
      wx.stopPullDownRefresh()
    }, 1000)
  },
  
  // 上拉触底时触发
  onReachBottom: function() {
    console.log('触发上拉触底')
    
    // 常用于加载更多数据
  },
  
  // 用户点击右上角分享时触发
  onShareAppMessage: function() {
    return {
      title: '分享标题',
      path: '/pages/index/index',
      imageUrl: '分享图片'
    }
  },
  
  // 页面尺寸改变时触发
  onResize: function(size) {
    console.log('页面尺寸:', size)
  },
  
  // 点击 tab 时触发（仅在 tab 页面中触发）
  onTabItemTap: function(item) {
    console.log('点击的 tab 项:', item)
  }
})
```

## 组件生命周期

Component函数用于注册一个自定义组件：

```javascript
Component({
  // 组件属性
  properties: {
    myProperty: {
      type: String,
      value: ''
    }
  },
  
  // 组件数据
  data: {
    message: '组件内部数据'
  },
  
  // 组件生命周期
  lifetimes: {
    // 组件实例刚创建时触发
    created: function() {
      console.log('组件创建')
      
      // 此时不能调用 setData
    },
    
    // 组件实例进入页面节点树时触发
    attached: function() {
      console.log('组件attached')
      
      // 此时可以进行初始化工作
    },
    
    // 组件在视图层布局完成后执行
    ready: function() {
      console.log('组件ready')
    },
    
    // 组件实例被移动到节点树另一个位置时触发
    moved: function() {
      console.log('组件moved')
    },
    
    // 组件实例被从页面节点树移除时触发
    detached: function() {
      console.log('组件detached')
      
      // 清理工作
    },
    
    // 每当组件方法抛出错误时执行
    error: function(error) {
      console.error('组件error:', error)
    }
  },
  
  // 组件所在页面的生命周期
  pageLifetimes: {
    // 页面被展示时触发
    show: function() {
      console.log('组件所在页面show')
    },
    
    // 页面被隐藏时触发
    hide: function() {
      console.log('组件所在页面hide')
    },
    
    // 页面尺寸变化时触发
    resize: function(size) {
      console.log('组件所在页面resize:', size)
    }
  }
})
```

## 常见面试题

1. 微信小程序的应用生命周期和页面生命周期有哪些?
2. onLoad和onShow的区别是什么?
3. 如何在多个页面间共享数据?
4. 页面返回时，上一个页面的生命周期是怎样的?
5. 组件的生命周期与页面的生命周期有什么不同? 