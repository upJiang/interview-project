# 微信小程序版本控制

本文件介绍小程序的发布流程与版本管理

## 1. 小程序版本类型

微信小程序有完整的版本管理体系，包括开发版、体验版、审核版、线上版等不同类型。
通过系统化的版本控制，保证小程序的稳定发布和迭代更新。
同时，微信提供了灰度发布、条件编译等高级特性，支持复杂的版本管理需求。

## 2. 小程序版本类型概述

小程序版本类型:   
开发版本:
- 本地开发阶段使用
- 开发工具中预览和调试
- 可通过"预览"生成二维码分享给开发成员
- 每个开发者都可以有自己的开发版本
- 开发版仅管理员和项目成员可访问
体验版本:
- 开发完成后提交体验
- 可分享给体验成员测试
- 同一时间只能有一个体验版
- 用于测试和内部验收
- 体验版可在开发者工具中以及手机微信中打开
审核版本:
- 提交审核后的版本
- 等待微信官方审核
- 只有管理员和项目成员可预览
- 处于审核中状态，不可对外发布
线上版本:
- 审核通过后发布的版本
- 对所有用户可见
- 可在微信小程序入口中搜索打开
- 正式环境中运行的版本
各版本之间的流转:
本地开发 -> 上传代码 -> 提交体验 -> 提交审核 -> 发布上线


## 3. 版本发布流程

完整版本发布流程:
1. 本地开发
- 使用微信开发者工具进行开发
- 本地编译、预览、调试
- 确保功能正常、性能良好
2. 上传代码
- 开发者工具中点击"上传"
- 填写版本号和项目备注
- 选择相应的AppID
- 代码上传到微信服务器

上传时版本号格式
```json
{
  "version": "1.0.0",  // 版本号，格式为X.Y.Z
  "desc": "新增用户登录功能，修复已知问题"  // 版本描述
}
```

3. 提交体验
- 登录小程序管理后台
- 在"开发管理"中将上传的代码设为体验版
- 可添加体验成员进行测试
4. 测试阶段
- 体验成员使用体验码访问小程序
- 测试各项功能是否正常
- 收集反馈并修复问题
- 如发现问题，回到开发阶段修复，再次上传
5. 提交审核
- 提交体验版到微信官方审核
- 填写相关信息
* 提交人信息
* 审核项说明
* 测试帐号(如需要)
* 包含的功能类目
* 服务类目所需资质材料
- 审核周期通常为1-7天
6. 审核结果处理
- 审核通过: 可以发布上线
- 审核不通过: 查看原因，修改后重新提交
- 可在微信公众平台查看审核进度和历史
7. 发布线上版本
- 审核通过后，可以在管理后台发布
- 点击"发布"按钮将审核版本设为线上版本
- 用户可在微信中访问最新版本
8. 版本发布后管理
- 监控小程序运行状况
- 收集用户反馈
- 分析数据表现
- 规划下一版本迭代


## 4. 版本号管理

### 小程序版本号格式
- 通常采用语义化版本号(SemVer): X.Y.Z
- X: 主版本号，不兼容的API修改
- Y: 次版本号，向下兼容的功能性新增
- Z: 修订号，向下兼容的问题修正

### 版本号递增规则
- 主版本号: 当做了不兼容的API修改，如重构核心流程
- 次版本号: 当做了向下兼容的功能性新增，如新增页面或功能
- 修订号: 当做了向下兼容的问题修正，如Bug修复

### 版本号示例
- 1.0.0: 首次发布版本
- 1.0.1: 修复Bug
- 1.1.0: 新增功能但保持兼容
- 2.0.0: 重大更新，可能不向下兼容

### 版本号管理建议
- 在package.json或单独的version文件中管理
- 与Git标签(tag)结合使用
- 每次提交审核前更新版本号
- 在开发者工具上传时确保使用正确版本号
- 保持版本日志记录每个版本的变更

### 版本号自动化
可以通过脚本实现版本号自动更新，例如自动更新修订号的Node.js脚本：

```javascript
const fs = require('fs');
const path = require('path');

// 读取package.json
const pkgPath = path.join(__dirname, 'package.json');
const pkg = require(pkgPath);

// 版本号分解
const versions = pkg.version.split('.');
const major = parseInt(versions[0]);
const minor = parseInt(versions[1]);
const patch = parseInt(versions[2]) + 1;  // 增加修订号

// 更新版本号
pkg.version = `${major}.${minor}.${patch}`;

// 写回package.json
fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2));

console.log(`版本已更新到 ${pkg.version}`);
```

## 5. 小程序更新机制

### 更新机制流程
1. 小程序启动
2. 微信检查是否有新版本
3. 如有新版本，在后台下载
4. 下次冷启动时使用新版本

### 默认更新特点
- 静默更新，用户无感知
- 不会打断当前使用，需要下次冷启动生效
- 热启动（从后台切回前台）不会触发更新
- 同一版本24小时内更新最多提示一次

### 主动检查更新的代码

```javascript
// app.js
App({
  onLaunch() {
    // 获取更新管理器
    const updateManager = wx.getUpdateManager();
    
    // 监听检查更新结果
    updateManager.onCheckForUpdate(function(res) {
      // res.hasUpdate表示是否有新版本
      console.log(res.hasUpdate);
    });
    
    // 监听新版本下载完成
    updateManager.onUpdateReady(function() {
      wx.showModal({
        title: '更新提示',
        content: '新版本已经准备好，是否重启应用？',
        success(res) {
          if (res.confirm) {
            // 新的版本已经下载好，调用 applyUpdate 应用新版本并重启
            updateManager.applyUpdate();
          }
        }
      });
    });
    
    // 监听新版本下载失败
    updateManager.onUpdateFailed(function() {
      // 新版本下载失败
      wx.showModal({
        title: '更新提示',
        content: '新版本下载失败，请检查网络后重试',
        showCancel: false
      });
    });
  }
});
```

### 更新策略建议
- 重要更新主动提示用户
- 优化更新体验，避免用户流失
- 在合适时机提示重启小程序
- 灰度发布重要功能，控制风险

## 6. 灰度发布

```javascript
function grayscaleRelease() {
  // 灰度发布(又称金丝雀发布)是一种发布策略，
  // 允许向部分用户发布新版本，验证稳定性后再全量发布
  // 小程序灰度发布流程:
  // 1. 上传并审核新版本
  // 2. 审核通过后，在管理后台选择"灰度发布"
  // 3. 设置灰度比例(如10%、20%、50%等)
  // 4. 系统按比例随机向用户推送新版本
  // 5. 观察新版本表现，确认无问题后全量发布
  // 灰度发布设置:
  // - 登录小程序管理后台
  // - 在"版本管理"中找到审核通过的版本
  // - 点击"灰度发布"按钮
  // - 设置灰度比例(百分比)
  // - 确认发布
  // 灰度发布优势:
  // - 降低风险: 问题仅影响部分用户
  // - 可控性强: 可随时调整灰度比例或回退
  // - 数据验证: 可对比新旧版本性能和用户反馈
  // - 渐进式推广: 稳定后逐步提高比例
  // 灰度发布监控:
  // - 关注新版本用户反馈
  // - 监控崩溃率和性能指标
  // - 比较新旧版本的关键指标差异
  // - 根据数据决定是否继续提高灰度比例
  // 灰度发布注意事项:
  // - 确保新旧版本数据兼容
  // - 服务端接口需支持多版本并行
  // - 灰度期间要密切监控运行状况
  // - 准备回滚方案，以应对严重问题
}
``` 